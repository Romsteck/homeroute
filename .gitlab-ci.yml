stages:
  - install
  - lint
  - build

image: node:22-alpine

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - api/node_modules/
    - web/node_modules/

# Stage 1: Installation des dépendances
install:
  stage: install
  script:
    - npm run install:all
  artifacts:
    paths:
      - node_modules/
      - api/node_modules/
      - web/node_modules/
    expire_in: 1 hour

# Stage 2: Lint (qualité du code)
lint:frontend:
  stage: lint
  needs: [install]
  script:
    - cd web && npm run lint

lint:backend:
  stage: lint
  needs: [install]
  script:
    - cd api && npm run lint

# Stage 3: Build
build:frontend:
  stage: build
  needs: [lint:frontend, lint:backend]
  script:
    - cd web && npm run build
  artifacts:
    paths:
      - web/dist/
    expire_in: 1 week

build:backend:
  stage: build
  needs: [lint:frontend, lint:backend]
  script:
    - cd api && node -e "import('./src/index.js')"
